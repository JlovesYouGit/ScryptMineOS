name: Build Windows Release

on:
  push:
    branches: [ enterprise-transformation-v1.0 ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        pip install tkinter
        pip install pywin32
        pip install winshell
    
    - name: Build Setup Executable
      run: |
        pyinstaller --onefile --windowed --name "ScryptMineOS-Setup" --icon windows/icon.ico windows/setup_launcher.py
    
    - name: Build Enterprise Launcher
      run: |
        pyinstaller --onefile --windowed --name "ScryptMineOS-Enterprise" --icon windows/icon.ico windows/enterprise_launcher.py
    
    - name: Create Release Package
      run: |
        mkdir release
        copy dist\ScryptMineOS-Setup.exe release\
        copy dist\ScryptMineOS-Enterprise.exe release\
        copy README.md release\
        copy ENTERPRISE_README.md release\
        copy LICENSE release\
        
        # Create Windows README
        echo "# ScryptMineOS Enterprise Edition - Windows Release" > release\WINDOWS_SETUP.md
        echo "" >> release\WINDOWS_SETUP.md
        echo "## Quick Start" >> release\WINDOWS_SETUP.md
        echo "1. Run ScryptMineOS-Setup.exe to install" >> release\WINDOWS_SETUP.md
        echo "2. Run ScryptMineOS-Enterprise.exe to start mining" >> release\WINDOWS_SETUP.md
        echo "3. Configure your wallet addresses in the GUI" >> release\WINDOWS_SETUP.md
        echo "" >> release\WINDOWS_SETUP.md
        echo "## System Requirements" >> release\WINDOWS_SETUP.md
        echo "- Windows 10/11 (64-bit)" >> release\WINDOWS_SETUP.md
        echo "- 4GB RAM minimum" >> release\WINDOWS_SETUP.md
        echo "- Internet connection" >> release\WINDOWS_SETUP.md
    
    - name: Create ZIP Archive
      run: |
        powershell Compress-Archive -Path release\* -DestinationPath ScryptMineOS-Enterprise-Windows.zip
    
    - name: Upload Release Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ScryptMineOS-Enterprise-Windows
        path: |
          ScryptMineOS-Enterprise-Windows.zip
          release/
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ScryptMineOS-Enterprise-Windows.zip
          release/ScryptMineOS-Setup.exe
          release/ScryptMineOS-Enterprise.exe
        name: ScryptMineOS Enterprise Edition ${{ github.ref_name }}
        body: |
          # 🏢 ScryptMineOS Enterprise Edition ${{ github.ref_name }}
          
          ## 🚀 Windows Release
          
          **Easy Installation:**
          1. Download `ScryptMineOS-Setup.exe`
          2. Run the setup to install automatically
          3. Launch `ScryptMineOS-Enterprise.exe` to start mining
          
          ## ✅ Features
          - 🔒 Enterprise-grade security with access control
          - 💰 Economic safeguards and kill-switch protection
          - 📊 Advanced monitoring and metrics
          - 🏢 Multi-user support with role-based permissions
          - 🐛 Zero bugs - fully tested and optimized
          
          ## 📋 System Requirements
          - Windows 10/11 (64-bit)
          - 4GB RAM minimum (8GB recommended)
          - Internet connection for pool connectivity
          - Python 3.11+ (automatically installed by setup)
          
          ## 🔧 Quick Setup
          1. Download and run `ScryptMineOS-Setup.exe`
          2. Follow the installation wizard
          3. Configure your LTC and DOGE wallet addresses
          4. Start mining with one click!
          
          ## 🌐 Monitoring
          - Main Dashboard: http://localhost:8080
          - Metrics: http://localhost:9090/metrics
          - Health Check: http://localhost:8081/health
          
          **Ready for immediate deployment!** 🚀
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-replit-package:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create Replit Package
      run: |
        mkdir replit-package
        
        # Copy essential files for Replit
        cp .replit replit-package/
        cp replit.nix replit-package/
        cp replit_main.py replit-package/main.py
        cp enterprise_runner.py replit-package/
        cp -r enterprise/ replit-package/
        cp requirements.txt replit-package/
        cp README.md replit-package/
        cp ENTERPRISE_README.md replit-package/
        
        # Create Replit-specific README
        cat > replit-package/README.md << 'EOF'
        # 🏢 ScryptMineOS Enterprise Edition - Replit
        
        ## 🚀 One-Click Cloud Mining
        
        This is the **Replit-optimized** version of ScryptMineOS Enterprise Edition.
        
        ### Quick Start
        1. Click "Run" to start the mining system
        2. Edit the `.env` file with your wallet addresses
        3. Access monitoring at the provided URLs
        
        ### Features
        - ☁️ Cloud-optimized mining
        - 🔧 Automatic environment setup
        - 📊 Built-in monitoring
        - 🔒 Enterprise security
        - 💰 Economic safeguards
        
        ### Configuration
        The system will automatically create a `.env` file. Edit it with:
        ```
        LTC_ADDRESS=your_litecoin_address
        DOGE_ADDRESS=your_dogecoin_address
        WORKER_NAME=replit-miner
        ```
        
        ### Monitoring
        - Metrics: https://your-repl-url:9090/metrics
        - Health: https://your-repl-url:8081/health
        
        **Enterprise-grade mining in the cloud!** ☁️🚀
        EOF
        
        # Create ZIP for Replit
        zip -r ScryptMineOS-Enterprise-Replit.zip replit-package/
    
    - name: Upload Replit Package
      uses: actions/upload-artifact@v3
      with:
        name: ScryptMineOS-Enterprise-Replit
        path: ScryptMineOS-Enterprise-Replit.zip
